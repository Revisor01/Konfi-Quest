<meta charset="UTF-8">
<h1>Konfi Management API Dokumentation</h1>

<h2>Übersicht</h2>

<p>Die <code>konfi-managment.js</code> Route verwaltet alle CRUD-Operationen für Konfis (Konfirmanden) im System. Diese API unterstützt das neue RBAC-System mit organization_id-basierter Isolation.</p>

<hr />

<h2>Authentifizierung &amp; Berechtigung</h2>

<ul>
<li>Alle Routen erfordern <code>rbacVerifier</code> Middleware</li>
<li>Spezifische Permissions werden für jede Operation geprüft</li>
<li>Organization-basierte Isolation wird durchgesetzt</li>
</ul>

<hr />

<h2>API Endpoints</h2>

<h3>1. GET <code>/api/admin/konfis</code></h3>

<p><strong>Zweck:</strong> Liste aller Konfis für die Admin-Organisation abrufen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.view</code></p>

<p><strong>Parameter:</strong> 
- Automatische Jahrgang-Filterung basierend auf Admin-Permissions</p>

<p><strong>Response:</strong>
<code>json
[
  {
    "id": 123,
    "name": "Max Mustermann",
    "username": "max.mustermann",
    "password_plain": "Abraham123",
    "gottesdienst_points": 15,
    "gemeinde_points": 8,
    "jahrgang_name": "2024/25",
    "jahrgang_id": 5,
    "badgeCount": 3
  }
]
</code></p>

<p><strong>SQL Query:</strong>
<code>sql
SELECT u.id, u.display_name as name, u.username, kp.password_plain, 
       kp.gottesdienst_points, kp.gemeinde_points,
       j.name as jahrgang_name, j.id as jahrgang_id,
       (SELECT COUNT(*) FROM konfi_badges WHERE konfi_id = u.id) as "badgeCount"
FROM users u
JOIN roles r ON u.role_id = r.id
LEFT JOIN konfi_profiles kp ON u.id = kp.user_id
LEFT JOIN jahrgaenge j ON kp.jahrgang_id = j.id
WHERE r.name = 'konfi' AND u.organization_id = $1 [+ jahrgang filter]
ORDER BY j.name DESC, u.display_name
</code></p>

<hr />

<h3>2. GET <code>/api/admin/konfis/:id</code></h3>

<p><strong>Zweck:</strong> Einzelnen Konfi mit vollständigen Details laden</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.view</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Response:</strong>
<code>json
{
  "id": 123,
  "name": "Max Mustermann",
  "username": "max.mustermann",
  "password": "Abraham123",
  "gottesdienst_points": 15,
  "gemeinde_points": 8,
  "jahrgang_name": "2024/25",
  "jahrgang_id": 5,
  "badgeCount": 3,
  "activities": [
    {
      "id": 45,
      "name": "Gottesdienst besuchen",
      "points": 2,
      "type": "gottesdienst",
      "completed_date": "2024-01-15",
      "admin_name": "Admin User"
    }
  ],
  "bonusPoints": [
    {
      "id": 67,
      "points": 5,
      "type": "gemeinde",
      "description": "Besondere Hilfe",
      "created_at": "2024-01-20",
      "admin_name": "Admin User"
    }
  ]
}
</code></p>

<p><strong>Geladene Daten:</strong>
1. Konfi Grunddaten
2. Alle zugewiesenen Aktivitäten
3. Alle Bonuspunkte
4. Badge-Anzahl</p>

<hr />

<h3>3. POST <code>/api/admin/konfis</code></h3>

<p><strong>Zweck:</strong> Neuen Konfi erstellen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.create</code></p>

<p><strong>Request Body:</strong>
<code>json
{
  "name": "Max Mustermann",
  "jahrgang_id": 5
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "id": 123,
  "username": "max.mustermann",
  "password": "Abraham123",
  "message": "Konfi created successfully"
}
</code></p>

<p><strong>Automatische Aktionen:</strong>
1. Username generieren: <code>name.toLowerCase().replace(/\s+/g, '.').replace(/[^a-z.äöüß]/g, '')</code>
2. Biblisches Passwort generieren
3. Passwort hashen (bcrypt)
4. User in <code>users</code> Tabelle erstellen
5. Profil in <code>konfi_profiles</code> erstellen mit Punkten = 0</p>

<p><strong>Transaktion:</strong> Ja (BEGIN/COMMIT/ROLLBACK)</p>

<hr />

<h3>4. PUT <code>/api/admin/konfis/:id</code></h3>

<p><strong>Zweck:</strong> Konfi-Daten bearbeiten</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.edit</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Request Body:</strong>
<code>json
{
  "name": "Max Mustermann",
  "jahrgang_id": 5
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Konfi updated successfully"
}
</code></p>

<p><strong>Geänderte Daten:</strong>
1. <code>users.display_name</code> und <code>users.username</code>
2. <code>konfi_profiles.jahrgang_id</code></p>

<p><strong>Transaktion:</strong> Ja</p>

<hr />

<h3>5. DELETE <code>/api/admin/konfis/:id</code></h3>

<p><strong>Zweck:</strong> Konfi und alle Referenzen löschen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.delete</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Konfi deleted successfully"
}
</code></p>

<p><strong>⚠️ KRITISCHE LÖSCHVORGÄNGE (in dieser Reihenfolge):</strong>
1. <code>konfi_activities</code> - Alle zugewiesenen Aktivitäten
2. <code>bonus_points</code> - Alle Bonuspunkte
3. <code>konfi_badges</code> - Alle erworbenen Badges
4. <code>activity_requests</code> - Alle Aktivitäts-Anträge
5. <code>chat_participants</code> - Chat-Teilnahmen
6. <code>konfi_profiles</code> - Konfi-Profil
7. <code>users</code> - User-Account</p>

<p><strong>Transaktion:</strong> Ja (kritisch für Datenintegrität)</p>

<hr />

<h3>6. POST <code>/api/admin/konfis/:id/regenerate-password</code></h3>

<p><strong>Zweck:</strong> Neues Passwort für Konfi generieren</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.reset_password</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Password regenerated successfully",
  "password": "Moses456"
}
</code></p>

<p><strong>Aktionen:</strong>
1. Neues biblisches Passwort generieren
2. Passwort hashen und in <code>users.password_hash</code> speichern
3. Klartext in <code>konfi_profiles.password_plain</code> speichern</p>

<p><strong>Transaktion:</strong> Ja</p>

<hr />

<h3>7. POST <code>/api/admin/konfis/:id/bonus-points</code></h3>

<p><strong>Zweck:</strong> Bonuspunkte für Konfi vergeben</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.edit</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Request Body:</strong>
<code>json
{
  "points": 5,
  "type": "gottesdienst",
  "description": "Besondere Hilfe beim Gottesdienst"
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Bonus points added successfully"
}
</code></p>

<p><strong>Aktionen:</strong>
1. Eintrag in <code>bonus_points</code> erstellen
2. Punkte zu <code>konfi_profiles.gottesdienst_points</code> oder <code>gemeinde_points</code> addieren</p>

<hr />

<h3>8. DELETE <code>/api/admin/konfis/:id/bonus-points/:bonusId</code></h3>

<p><strong>Zweck:</strong> Bonuspunkte löschen und von Gesamtpunkten abziehen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.edit</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID
- <code>:bonusId</code> - Bonus Points ID</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Bonus points deleted successfully"
}
</code></p>

<p><strong>Aktionen:</strong>
1. Bonuspunkt-Daten laden
2. Eintrag aus <code>bonus_points</code> löschen
3. Punkte von <code>konfi_profiles</code> Gesamtpunkten abziehen</p>

<hr />

<h3>9. POST <code>/api/admin/konfis/:id/activities</code></h3>

<p><strong>Zweck:</strong> Aktivität für Konfi zuweisen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.edit</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Request Body:</strong>
<code>json
{
  "activity_id": 10,
  "completed_date": "2024-01-15",
  "comment": "Optional comment"
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Activity added successfully"
}
</code></p>

<p><strong>Aktionen:</strong>
1. Aktivität aus <code>activities</code> laden
2. Eintrag in <code>konfi_activities</code> erstellen
3. Punkte basierend auf <code>activity.type</code> zu entsprechendem Feld addieren</p>

<hr />

<h3>10. DELETE <code>/api/admin/konfis/:id/activities/:activityId</code></h3>

<p><strong>Zweck:</strong> Zugewiesene Aktivität löschen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.edit</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID
- <code>:activityId</code> - Konfi Activity Record ID</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Activity deleted successfully"
}
</code></p>

<p><strong>Aktionen:</strong>
1. Aktivitäts-Daten laden (für Punkte-Korrektur)
2. Eintrag aus <code>konfi_activities</code> löschen
3. Punkte von <code>konfi_profiles</code> abziehen</p>

<hr />

<h3>11. GET <code>/api/admin/konfis/:id/event-points</code></h3>

<p><strong>Zweck:</strong> Event-Punkte für Konfi abrufen</p>

<p><strong>Berechtigung:</strong> <code>admin.konfis.view</code></p>

<p><strong>Parameter:</strong>
- <code>:id</code> - Konfi User ID</p>

<p><strong>Response:</strong>
<code>json
[
  {
    "id": 89,
    "points": 3,
    "point_type": "gottesdienst",
    "description": "Teilnahme an Event XYZ",
    "event_name": "Jugendgottesdienst",
    "event_date": "2024-01-20",
    "awarded_date": "2024-01-20",
    "admin_name": "Admin User"
  }
]
</code></p>

<hr />

<h2>Sicherheitsaspekte</h2>

<h3>Organization Isolation</h3>

<ul>
<li>Alle Queries enthalten <code>organization_id</code> Filter</li>
<li>Verhindert Cross-Organization Data Access</li>
</ul>

<h3>Transaktionale Sicherheit</h3>

<ul>
<li>Kritische Operations (CREATE, UPDATE, DELETE) verwenden Transaktionen</li>
<li>ROLLBACK bei Fehlern garantiert Datenintegrität</li>
</ul>

<h3>Jahrgang-basierte Zugriffskontrolle</h3>

<ul>
<li>Nicht-Super-Admins sehen nur zugewiesene Jahrgänge</li>
<li><code>assigned_jahrgaenge</code> mit <code>can_view</code> Permissions</li>
</ul>

<hr />

<h2>Fehlerbehandlung</h2>

<h3>Häufige Fehler:</h3>

<ul>
<li><code>404</code> - Konfi not found</li>
<li><code>409</code> - Username already exists (bei Creation)</li>
<li><code>400</code> - Missing required fields</li>
<li><code>500</code> - Database errors</li>
</ul>

<h3>Logging:</h3>

<ul>
<li>Alle Database Errors werden in Console geloggt</li>
<li>Request-spezifische Logs für Debugging</li>
</ul>

<hr />

<h2>Performance Considerations</h2>

<h3>Optimierte Queries:</h3>

<ul>
<li>Badge Counts als Subquery in der Hauptabfrage</li>
<li>LEFT JOINs für optionale Daten</li>
<li>INDEX auf foreign keys sollte vorhanden sein</li>
</ul>

<h3>Batch Operations:</h3>

<ul>
<li>Einzelne Konfi-Details laden alle zugehörigen Daten in separaten Queries</li>
<li>Könnte für große Datensätze optimiert werden</li>
</ul>
