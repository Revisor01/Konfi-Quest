---
phase: 02-bug-fixes-und-theme-stabilisierung
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/layout/MainTabs.tsx
  - frontend/src/theme/variables.css
autonomous: true
requirements: [BUG-01, THM-01, THM-02, THM-03, THM-04]

must_haves:
  truths:
    - "Die TabBar zeigt alle 6 Tabs auf iOS korrekt an, ohne Render-Fehler oder abgeschnittene Icons"
    - "Auf iOS rendert die App im iOS 26 Stil (Floating TabBar, abgerundete Ecken, Glass-Effekt)"
    - "Auf Android rendert die App im Material Design 3 Stil, ohne sichtbare iOS26-Artefakte"
    - "Die CSS-basierte Tab-Button Press-Animation funktioniert weiterhin auf iOS"
    - "Die 3 unscoped ion-content Gradient-Regeln aus iOS26 erzeugen keine sichtbaren Artefakte auf Android"
  artifacts:
    - path: "frontend/src/components/layout/MainTabs.tsx"
      provides: "TabBar ohne registerTabBarEffect JS-Code"
      contains: "IonTabBar"
    - path: "frontend/src/theme/variables.css"
      provides: "Optional verstaerkter backdrop-filter fuer iOS TabBar und Android-Gradient-Fix falls noetig"
  key_links:
    - from: "frontend/src/theme/variables.css"
      to: "@rdlabo/ionic-theme-ios26 CSS"
      via: "@import Statements"
      pattern: "@import.*ionic-theme-ios26"
    - from: "frontend/src/theme/variables.css"
      to: "@rdlabo/ionic-theme-md3 CSS"
      via: "@import Statements"
      pattern: "@import.*ionic-theme-md3"
---

<objective>
TabBar-Fix durch Entfernung von registerTabBarEffect und Verifikation der Theme-Isolation zwischen iOS26 und MD3.

Purpose: Die TabBar bricht aktuell bei 6 Tabs auf iOS wegen des JS-basierten registerTabBarEffect. Der CSS-only-Ansatz der Library funktioniert korrekt fuer 6+ Tabs. Ausserdem muss sichergestellt werden, dass iOS26- und MD3-Themes sich nicht gegenseitig stoeren.

Output: Funktionierende TabBar auf iOS mit 6 Tabs, verifizierte Theme-Isolation
</objective>

<execution_context>
@/Users/simonluthe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simonluthe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-CONTEXT.md
@.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-RESEARCH.md

@frontend/src/components/layout/MainTabs.tsx
@frontend/src/theme/variables.css
@frontend/node_modules/@rdlabo/ionic-theme-ios26/dist/css/ionic-theme-ios26.css
@frontend/node_modules/@rdlabo/ionic-theme-md3/dist/css/ionic-theme-md3.css

<interfaces>
<!-- Aus MainTabs.tsx: Relevante Imports und Patterns -->
```typescript
// Zeile 29 -- ZU ENTFERNEN:
import { registerTabBarEffect } from '@rdlabo/ionic-theme-ios26';

// Zeile 156-169 -- KOMPLETT ZU ENTFERNEN:
const tabBarEffectRef = useRef<ReturnType<typeof registerTabBarEffect>>(undefined);
useEffect(() => { ... }, [location.pathname]);
```

<!-- Aus variables.css: Theme-Import-Reihenfolge (Zeile 4-11) -->
```css
@import '@rdlabo/ionic-theme-ios26/dist/css/default-variables.css';
@import '@rdlabo/ionic-theme-ios26/dist/css/ionic-theme-ios26.css';
@import '@rdlabo/ionic-theme-ios26/dist/css/md-remove-ios-class-effect.css';
@import '@rdlabo/ionic-theme-md3/dist/css/default-variables.css';
@import '@rdlabo/ionic-theme-md3/dist/css/ionic-theme-md3.css';
```

<!-- iOS26 unscoped Regeln die auf Android sichtbar sein koennten: -->
```css
.ion-page:has(>ion-header.header-translucent)>ion-content::part(background)::before { ... }
ion-content::part(background)::after { ... }
.ion-page:has(>ion-footer:not(.footer-translucent)) ion-content::part(background)::after { content: none }
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: registerTabBarEffect entfernen und optionalen iOS-Blur verstaerken</name>
  <files>frontend/src/components/layout/MainTabs.tsx, frontend/src/theme/variables.css</files>
  <action>
In `MainTabs.tsx`:
1. **Import entfernen** (Zeile 29): Die Zeile `import { registerTabBarEffect } from '@rdlabo/ionic-theme-ios26';` komplett loeschen.
2. **useRef entfernen** (Zeile 156): Die Zeile `const tabBarEffectRef = useRef<ReturnType<typeof registerTabBarEffect>>(undefined);` komplett loeschen.
3. **useEffect-Block entfernen** (Zeile 157-169): Den kompletten useEffect-Block entfernen, der den registerTabBarEffect registriert:
   ```typescript
   useEffect(() => {
     const timer = setTimeout(() => {
       tabBarEffectRef.current?.destroy();
       const tabBar = document.querySelector<HTMLElement>('ion-tab-bar');
       if (tabBar) {
         tabBarEffectRef.current = registerTabBarEffect(tabBar);
       }
     }, 100);
     return () => {
       clearTimeout(timer);
       tabBarEffectRef.current?.destroy();
     };
   }, [location.pathname]);
   ```
4. **Pruefen ob `useRef` noch anderweitig verwendet wird.** Falls nicht, `useRef` aus dem React-Import entfernen. ACHTUNG: `useLocation` und `useEffect` werden weiterhin von anderen Code-Teilen in der Datei benoetigt -- NUR `useRef` ggf. entfernen.
5. **Kommentar `// iOS 26 Tab-Bar Animation Effect` (Zeile 155) ebenfalls entfernen.**

In `variables.css`:
6. **Optionalen verstaerkten Blur-Effekt hinzufuegen** -- NACH den bestehenden Theme-Imports und den `:root` Variablen, aber innerhalb der Datei, folgendes CSS hinzufuegen:
   ```css
   /* iOS 26 TabBar: Verstaerkter Blur-Effekt (naeher am nativen iOS 26 Look) */
   /* Die Library setzt blur(2px) saturate(360%) -- wir erhoehen fuer realistischeren Glass-Effekt */
   ion-tab-bar.ios:not(.ios26-disabled) {
     backdrop-filter: blur(20px) saturate(180%);
     -webkit-backdrop-filter: blur(20px) saturate(180%);
   }
   ```
   Dieses CSS muss NACH dem `@import` der ionic-theme-ios26.css kommen, damit es die Library-Werte ueberschreibt. Da die imports am Anfang der Datei stehen, kann es an einer semantisch passenden Stelle weiter unten in der Datei platziert werden (z.B. nach den `:root` Variablen-Bloecken, vor den Utility-Klassen).

WICHTIG: Die CSS-Styles der Library fuer die TabBar (Floating-Style, abgerundete Ecken, Positionierung, Press-Animation) bleiben KOMPLETT erhalten. Nur der JS-basierte Effect wird entfernt.
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/frontend && grep -c "registerTabBarEffect" src/components/layout/MainTabs.tsx | grep "^0$" && grep -c "tabBarEffectRef" src/components/layout/MainTabs.tsx | grep "^0$" && grep -c "backdrop-filter.*blur(20px)" src/theme/variables.css | grep "^[1-9]" && echo "PASS"</automated>
  </verify>
  <done>
    - registerTabBarEffect Import ist aus MainTabs.tsx entfernt
    - tabBarEffectRef und zugehoeriger useEffect sind aus MainTabs.tsx entfernt
    - Kommentar "iOS 26 Tab-Bar Animation Effect" ist entfernt
    - useRef ist aus dem React-Import entfernt (falls nicht anderweitig verwendet)
    - Verstaerkter backdrop-filter ist in variables.css vorhanden
    - Die restliche MainTabs.tsx-Logik (Routing, Badge-Counts, Tab-Hiding) ist unveraendert
  </done>
</task>

<task type="auto">
  <name>Task 2: Theme-Isolation verifizieren und unscoped iOS26-Regeln auf Android neutralisieren</name>
  <files>frontend/src/theme/variables.css</files>
  <action>
Theme-Isolation Code-Verifikation:

1. **Pruefen: Greifen die 3 unscoped ion-content-Regeln auf Android?**
   - Oeffne `frontend/node_modules/@rdlabo/ionic-theme-ios26/dist/css/ionic-theme-ios26.css`
   - Suche die 3 unscoped Regeln:
     a. `.ion-page:has(>ion-header.header-translucent)>ion-content::part(background)::before`
     b. `ion-content::part(background)::after`
     c. `.ion-page:has(>ion-footer:not(.footer-translucent)) ion-content::part(background)::after`
   - Analysiere ob `.header-translucent` auf Android-Plattform gesetzt wird. Ionic setzt `header-translucent` typischerweise nur bei `<IonHeader translucent={true}>` -- das funktioniert auf beiden Plattformen. Die Regel (a) greift also AUCH auf Android wenn Header translucent ist.
   - Regel (b) `ion-content::part(background)::after` ist komplett unscoped und greift ueberall.

2. **Android-Fix in variables.css hinzufuegen:**
   Direkt nach dem iOS-TabBar-Blur-Block (aus Task 1) folgendes CSS einfuegen:
   ```css
   /* Android: iOS26 unscoped Content-Gradient neutralisieren */
   /* Die iOS26-Library hat 3 Regeln ohne .ios Scoping die auf Android sichtbar waeren */
   .md ion-content::part(background)::before,
   .md ion-content::part(background)::after {
     content: none !important;
   }
   ```
   Das `!important` ist hier korrekt, weil wir eine Library-Regel auf einer Plattform deaktivieren muessen, auf der sie nie greifen sollte. Die `.md` Klasse stellt sicher, dass dies NUR auf Android wirkt.

3. **Verifikation der Theme-Variable-Namespaces:**
   - Bestaetigen dass iOS26-Variablen `--ios26-*` und MD3-Variablen `--token-*` verschiedene Namespaces verwenden (aus Research bereits bestaetigt).
   - Bestaetigen dass die `--ion-color-*-brightness` Variablen in variables.css NACH beiden Theme-Imports stehen und daher korrekt ueberschreiben.
   - Kein Code noetig falls beides bestaetigt. Ergebnis im SUMMARY dokumentieren.

4. **Verifikation der CSS-Import-Reihenfolge:**
   - iOS26 imports kommen VOR MD3 imports. Das ist korrekt: Bei gleicher Spezifitaet wuerde MD3 gewinnen, aber da Selektoren verschiedene Plattform-Klassen (`.ios`/`.md`) nutzen, matcht immer nur einer.
   - Kein Code noetig. Ergebnis im SUMMARY dokumentieren.

KEIN visuelles Redesign, KEINE proaktive Variablen-Isolation -- nur die identifizierten unscoped Regeln neutralisieren (per User-Entscheidung: "Testen und nur bei Bedarf fixen").
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/frontend && grep -c "\.md ion-content::part(background)" src/theme/variables.css | grep "^[1-9]" && echo "PASS"</automated>
  </verify>
  <done>
    - Die 3 unscoped ion-content-Gradient-Regeln aus iOS26 sind auf Android (.md) neutralisiert
    - Theme-Variable-Namespaces sind verifiziert (kein Konflikt zwischen --ios26-* und --token-*)
    - CSS-Import-Reihenfolge ist verifiziert (korrekt)
    - Keine visuellen Artefakte der iOS26-Library auf Android-Plattform moeglich
  </done>
</task>

</tasks>

<verification>
1. `grep -c "registerTabBarEffect" frontend/src/components/layout/MainTabs.tsx` ergibt 0
2. `grep -c "tabBarEffectRef" frontend/src/components/layout/MainTabs.tsx` ergibt 0
3. `grep "backdrop-filter.*blur(20px)" frontend/src/theme/variables.css` findet den verstaerkten Blur
4. `grep "\.md ion-content" frontend/src/theme/variables.css` findet den Android-Gradient-Fix
5. `cd frontend && npx tsc --noEmit` kompiliert ohne Fehler (TypeScript-Check)
6. `cd frontend && npm run build` baut erfolgreich (Vite-Build)
</verification>

<success_criteria>
- registerTabBarEffect JS-Code ist vollstaendig aus MainTabs.tsx entfernt
- Die Library-CSS-Styles (Floating TabBar, Press-Animation, Glass-Background) bleiben erhalten
- Der backdrop-filter ist auf blur(20px) verstaerkt fuer nativen iOS-26-Look
- iOS26 unscoped Content-Gradienten sind auf Android neutralisiert
- Theme-Imports und Variablen-Namespaces sind als konfliktfrei verifiziert
- Frontend kompiliert und baut erfolgreich
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-01-SUMMARY.md`
</output>
