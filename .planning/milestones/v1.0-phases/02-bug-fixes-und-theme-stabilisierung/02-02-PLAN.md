---
phase: 02-bug-fixes-und-theme-stabilisierung
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/utils/dateUtils.ts
  - frontend/src/components/konfi/pages/KonfiBadgesPage.tsx
autonomous: false
requirements: [BUG-02, BUG-03, BUG-04]

must_haves:
  truths:
    - "Die deprecated Funktionen parseGermanTime und getGermanNow existieren nicht mehr in dateUtils.ts"
    - "Badge-Punkte in der Konfi-Uebersicht stimmen exakt mit der Summe aus konfi_profiles ueberein (kein Double-Count)"
    - "Der Fallback-Pfad in KonfiBadgesPage ist gegen Double-Counting abgesichert"
    - "Bei systematischem Code-Review treten keine safe-area, overflow oder hardcodierte Hoehen-Probleme auf"
  artifacts:
    - path: "frontend/src/utils/dateUtils.ts"
      provides: "Bereinigte Date-Utilities ohne deprecated Funktionen"
    - path: "frontend/src/components/konfi/pages/KonfiBadgesPage.tsx"
      provides: "Abgesicherte Badge-Punkte-Berechnung ohne Double-Count-Risiko"
  key_links:
    - from: "frontend/src/components/konfi/pages/KonfiBadgesPage.tsx"
      to: "backend/routes/konfi.js"
      via: "API call /konfi/dashboard und /konfi/badges"
      pattern: "api\\.get.*konfi"
    - from: "backend/routes/konfi.js"
      to: "konfi_profiles Tabelle"
      via: "SQL Query mit gottesdienst_points + gemeinde_points"
      pattern: "konfi_profiles"
---

<objective>
Deprecated dateUtils entfernen, Badge-Punkte-Logik gegen Double-Count absichern und systematischen UI-Code-Review durchfuehren.

Purpose: Drei unabhaengige Cleanup- und Verifikations-Aufgaben die die Code-Qualitaet und Korrektheit der Daten-Darstellung sicherstellen. BUG-03 ist reines Cleanup, BUG-02 verhindert potenzielle Daten-Inkonsistenz, BUG-04 ist ein praeventiver Review.

Output: Bereinigte dateUtils, abgesicherte Badge-Berechnung, dokumentierte UI-Review-Ergebnisse
</objective>

<execution_context>
@/Users/simonluthe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simonluthe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-CONTEXT.md
@.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-RESEARCH.md

@frontend/src/utils/dateUtils.ts
@frontend/src/components/konfi/pages/KonfiBadgesPage.tsx
@backend/routes/konfi.js

<interfaces>
<!-- dateUtils.ts: Zeile 117-133 -- ZU ENTFERNEN -->
```typescript
export const parseGermanTime = (dateString: string): Date => {
  console.warn('parseGermanTime is deprecated, use parseLocalTime instead');
  return parseLocalTime(dateString);
};

export const getGermanNow = (): Date => {
  console.warn('getGermanNow is deprecated, use getLocalNow instead');
  return getLocalNow();
};
```

<!-- KonfiBadgesPage.tsx: Zeile 88-141 -- Fallback-Pfad mit Double-Count-Risiko -->
```typescript
// If points are null/undefined, calculate from activities + bonus
if (currentGottesdienstPoints === null || currentGottesdienstPoints === undefined ||
    currentGemeindePoints === null || currentGemeindePoints === undefined) {
  // ... berechnet Punkte manuell aus activities + bonusPoints
}
```

<!-- Backend konfi.js: Zeile 122-124 -- Korrekte Punkte-Berechnung -->
```javascript
// Total points: konfi_profiles contains gottesdienst + gemeinde (inkl. Events UND Bonus)
// Bonus ist bereits in konfi_profiles enthalten, daher NICHT nochmal addieren
const totalPoints = (konfi.gottesdienst_points || 0) + (konfi.gemeinde_points || 0);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deprecated dateUtils entfernen und Badge-Fallback absichern</name>
  <files>frontend/src/utils/dateUtils.ts, frontend/src/components/konfi/pages/KonfiBadgesPage.tsx</files>
  <action>
**dateUtils.ts Cleanup (BUG-03):**
1. In `frontend/src/utils/dateUtils.ts` die Zeilen 117-133 komplett entfernen:
   - Den Kommentarblock `/** DEPRECATED - use parseLocalTime instead ... */`
   - Die Funktion `parseGermanTime`
   - Den Kommentarblock `/** DEPRECATED - use getLocalNow instead ... */`
   - Die Funktion `getGermanNow`
2. Sicherstellen dass keine andere Datei diese Funktionen importiert (Research bestaetigt: nur in dateUtils.ts definiert, nirgends importiert).

**KonfiBadgesPage.tsx Absicherung (BUG-02):**
3. In `frontend/src/components/konfi/pages/KonfiBadgesPage.tsx` den Fallback-Pfad (Zeile 92-141) wie folgt aendern:

   Der aktuelle Code hat einen `if (null/undefined)` Check und berechnet dann manuell aus activities + bonus. Das Backend liefert per COALESCE immer Werte (nie null). Der Fallback-Pfad ist daher toter Code mit Double-Count-Risiko.

   **Ansatz: Fallback-Pfad entfernen und nur API-Punkte verwenden.**

   Ersetze den gesamten Block (Zeile 88-141) durch:
   ```typescript
   // Punkte direkt aus konfi_profiles verwenden
   // Backend liefert per COALESCE immer Werte (nie null)
   // konfi_profiles enthaelt bereits Aktivitaets- + Event- + Bonus-Punkte (akkumuliert)
   const currentGottesdienstPoints = konfiData.gottesdienst_points || 0;
   const currentGemeindePoints = konfiData.gemeinde_points || 0;
   const currentTotalPoints = konfiData.total_points || (currentGottesdienstPoints + currentGemeindePoints);
   ```

   Dadurch wird:
   - Der Fallback-Pfad mit manuellem Berechnen komplett entfernt
   - Die console.log-Aufrufe fuer Debug-Zwecke entfernt
   - Das Double-Count-Risiko eliminiert
   - Der Code deutlich vereinfacht

4. Bestaetige per grep dass `konfiData.activities` und `konfiData.bonusPoints` nicht mehr fuer die Punkte-Berechnung in dieser Datei verwendet werden (sie koennen fuer andere Zwecke wie Badge-Progress-Darstellung weiterhin genutzt werden).
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/frontend && grep -c "parseGermanTime\|getGermanNow" src/utils/dateUtils.ts | grep "^0$" && grep -c "calculating from activities" src/components/konfi/pages/KonfiBadgesPage.tsx | grep "^0$" && echo "PASS"</automated>
  </verify>
  <done>
    - parseGermanTime und getGermanNow sind aus dateUtils.ts entfernt
    - KonfiBadgesPage verwendet nur noch API-Punkte direkt (kein manuelles Berechnen)
    - Kein Double-Count-Risiko mehr vorhanden
    - Debug console.log Aufrufe sind entfernt
  </done>
</task>

<task type="auto">
  <name>Task 2: Systematischer UI-Code-Review aller Views</name>
  <files>frontend/src/components/konfi/pages/KonfiBadgesPage.tsx</files>
  <action>
**UI-Code-Review (BUG-04):**
Systematischer Code-Review per grep und Datei-Analyse. Kein visuelles Durchklicken -- reiner Code-Review per User-Entscheidung.

1. **Safe-Area Pruefen:**
   - `grep -rn "safe-area\|env(safe-area" frontend/src/` -- Pruefen ob safe-area-inset CSS-Properties korrekt verwendet werden
   - Die iOS26-Library handhabt safe-area fuer die Floating TabBar automatisch (`--ios26-floating-safe-area-bottom`)
   - Pruefen ob es Pages gibt die manuell `padding-bottom` oder `margin-bottom` setzen die mit der Floating TabBar kollidieren koennten

2. **Hardcodierte Hoehen Pruefen:**
   - `grep -rn "height:.*px\|min-height:.*px\|max-height:.*px" frontend/src/` -- Suche nach hardcodierten Pixel-Hoehen in Components
   - Hardcodierte Hoehen sind in Ionic-Apps problematisch weil IonContent die Hoehe automatisch berechnet
   - AUSNAHME: Icon-Groessen, Avatare, Badges -- diese duerfen feste Groessen haben

3. **Overflow Pruefen:**
   - `grep -rn "overflow.*hidden\|overflow.*scroll" frontend/src/` -- Pruefen ob overflow-Regeln Content abschneiden
   - Besonderer Fokus auf Listen-Views die innerhalb von IonContent scrollen

4. **Tab-Bar-Overlap Pruefen:**
   - Die iOS26 Floating TabBar ist `position: absolute` und ueberlappt den Content
   - Pruefen ob Pages am unteren Rand genug Padding haben, damit Content nicht von der TabBar verdeckt wird
   - Die Library setzt `--ios26-floating-tab-bar-height` die in `ion-content` als `--offset-bottom` wirken sollte
   - Falls ion-content NICHT automatisch den Offset beruecksichtigt: einen globalen CSS-Fix in variables.css hinzufuegen

5. **Ergebnis-Dokumentation:**
   - Alle Findings im SUMMARY dokumentieren
   - Nur Probleme fixen die tatsaechlich gefunden werden
   - Design-Angleich (gleiche Listen, Layouts, Farblogiken) ist NICHT Phase 2 Scope

WICHTIG: Dieser Task ist ein Review. Falls KEINE Probleme gefunden werden, ist das ein valides Ergebnis. Nicht kuenstlich Probleme suchen.
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/frontend && npx tsc --noEmit 2>&1 | tail -5 && echo "TypeScript check complete"</automated>
  </verify>
  <done>
    - Systematischer Code-Review aller Views auf safe-area, hardcodierte Hoehen und overflow durchgefuehrt
    - Tab-Bar-Overlap mit Floating TabBar geprueft
    - Gefundene Probleme dokumentiert und (falls vorhanden) behoben
    - Keine UI-Fehler bei Code-Analyse sichtbar ODER gefundene Probleme gefixt
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Badge-Punkte-Logik wurde vereinfacht (Fallback-Pfad entfernt). Jetzt muessen die Live-Daten verifiziert werden um sicherzustellen, dass konfi_profiles tatsaechlich korrekte akkumulierte Werte enthaelt.
  </what-built>
  <how-to-verify>
    1. SSH-Zugang zum Server herstellen:
       `ssh root@server.godsapp.de`
    2. In den Postgres-Container gehen:
       `docker exec -it konfi-quest-db-1 psql -U konfi_user -d konfi_db`
    3. Folgende Query ausfuehren um Diskrepanzen zu finden:
       ```sql
       SELECT u.display_name,
         kp.gottesdienst_points as profil_gd,
         kp.gemeinde_points as profil_gem,
         COALESCE((SELECT SUM(a.points) FROM konfi_activities ka JOIN activities a ON ka.activity_id = a.id WHERE ka.konfi_id = u.id AND a.type = 'gottesdienst'), 0) as act_gd,
         COALESCE((SELECT SUM(a.points) FROM konfi_activities ka JOIN activities a ON ka.activity_id = a.id WHERE ka.konfi_id = u.id AND a.type = 'gemeinde'), 0) as act_gem,
         COALESCE((SELECT SUM(points) FROM bonus_points WHERE konfi_id = u.id AND type = 'gottesdienst'), 0) as bonus_gd,
         COALESCE((SELECT SUM(points) FROM bonus_points WHERE konfi_id = u.id AND type = 'gemeinde'), 0) as bonus_gem
       FROM users u
       JOIN konfi_profiles kp ON u.id = kp.user_id
       JOIN roles r ON u.role_id = r.id
       WHERE r.name = 'konfi'
       ORDER BY u.display_name LIMIT 20;
       ```
    4. Pruefen: profil_gd sollte >= act_gd + bonus_gd sein (Events kommen noch dazu)
    5. Falls Diskrepanzen: Im Resume-Signal beschreiben
  </how-to-verify>
  <resume-signal>Tippe "approved" wenn die Daten konsistent sind, oder beschreibe die Diskrepanzen</resume-signal>
</task>

</tasks>

<verification>
1. `grep -c "parseGermanTime\|getGermanNow" frontend/src/utils/dateUtils.ts` ergibt 0
2. `grep -c "calculating from activities" frontend/src/components/konfi/pages/KonfiBadgesPage.tsx` ergibt 0
3. `cd frontend && npx tsc --noEmit` kompiliert ohne Fehler
4. `cd frontend && npm run build` baut erfolgreich
5. Live-Daten-Verifikation via SSH (Checkpoint Task)
</verification>

<success_criteria>
- parseGermanTime und getGermanNow existieren nicht mehr in dateUtils.ts
- KonfiBadgesPage verwendet nur noch direkte API-Punkte ohne Fallback-Berechnung
- UI-Code-Review ist durchgefuehrt und dokumentiert (Findings oder "keine Probleme")
- Live-Daten-Verifikation bestaetigt Konsistenz der Punkte in konfi_profiles
- Frontend kompiliert und baut erfolgreich
</success_criteria>

<output>
After completion, create `.planning/phases/02-bug-fixes-und-theme-stabilisierung/02-02-SUMMARY.md`
</output>
