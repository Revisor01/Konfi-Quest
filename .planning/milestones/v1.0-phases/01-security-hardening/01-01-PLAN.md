---
phase: 01-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/package.json
  - backend/server.js
  - backend/routes/activities.js
  - backend/routes/konfi-managment.js
  - backend/middleware/validation.js
autonomous: true
requirements: [SEC-01, SEC-06]

must_haves:
  truths:
    - "Jeder HTTP-Response vom Backend enthaelt Security Headers (X-Content-Type-Options, X-Frame-Options, Referrer-Policy, etc.)"
    - "X-Powered-By Header wird nicht mehr gesendet"
    - "Template-Literal-Spaltennamen in SQL-Queries sind durch Whitelist-validierte Werte abgesichert"
    - "Ein ungueltiger type-Wert bei Bonus-/Aktivitaetspunkten fuehrt zu einem Fehler statt stillem Fallback auf gemeinde_points"
  artifacts:
    - path: "backend/middleware/validation.js"
      provides: "Zentrale Validierungs-Middleware (handleValidationErrors) und getPointField Helper"
      exports: ["handleValidationErrors", "getPointField"]
    - path: "backend/server.js"
      provides: "helmet() als erstes Middleware in der Chain"
      contains: "app.use(helmet("
  key_links:
    - from: "backend/server.js"
      to: "helmet"
      via: "require + app.use"
      pattern: "require.*helmet.*app\\.use.*helmet"
    - from: "backend/routes/activities.js"
      to: "backend/middleware/validation.js"
      via: "require + getPointField"
      pattern: "getPointField"
    - from: "backend/routes/konfi-managment.js"
      to: "backend/middleware/validation.js"
      via: "require + getPointField"
      pattern: "getPointField"
---

<objective>
Helmet fuer HTTP Security Headers installieren und aktivieren, SQL-Injection-Risiko durch Whitelist-Validierung fuer dynamische Spaltennamen beheben, und die zentrale Validierungs-Middleware vorbereiten.

Purpose: Schnelle Security-Gewinne erzielen -- helmet schuetzt alle Responses, Whitelist verhindert potenzielle SQL-Injection ueber dynamische Spaltennamen. Gleichzeitig wird middleware/validation.js als Grundlage fuer Plan 03 (express-validator) erstellt.
Output: helmet aktiviert in server.js, getPointField Helper in allen betroffenen Stellen, handleValidationErrors Middleware bereit.
</objective>

<execution_context>
@/Users/simonluthe/.claude/get-shit-done/workflows/execute-plan.md
@/Users/simonluthe/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-security-hardening/01-CONTEXT.md
@.planning/phases/01-security-hardening/01-RESEARCH.md

@backend/server.js
@backend/package.json
@backend/routes/activities.js
@backend/routes/konfi-managment.js

<interfaces>
<!-- Bestehende Middleware-Signatur in server.js -->
Middleware-Chain in server.js (Zeile 222-225):
```javascript
app.use(generalLimiter);
app.use(express.json());
```
helmet muss VOR generalLimiter eingefuegt werden.

<!-- Betroffene Template-Literal-Stellen in activities.js -->
activities.js Zeilen 210, 274, 373, 405:
```javascript
const pointField = request.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';
await db.query(`UPDATE konfi_profiles SET ${pointField} = ${pointField} + $1 WHERE user_id = $2`, [...]);
```

<!-- Betroffene Template-Literal-Stellen in konfi-managment.js -->
konfi-managment.js Zeilen 438, 479, 525, 571:
```javascript
const updateField = type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';
await db.query(`UPDATE konfi_profiles SET ${updateField} = ${updateField} + $1 WHERE user_id = $2`, [...]);
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Helmet installieren und in server.js aktivieren</name>
  <files>backend/package.json, backend/server.js</files>
  <action>
1. Im Verzeichnis `backend/` die Pakete installieren:
   ```bash
   cd backend && npm install helmet@^8.1.0 express-validator@^7.3.1
   ```
   (express-validator wird in Plan 03 benoetigt, wird jetzt schon installiert damit Plan 03 keinen npm install braucht)

2. In `backend/server.js` helmet importieren -- nach den bestehenden require-Statements (nach Zeile 13 `const rateLimit = require('express-rate-limit');`):
   ```javascript
   const helmet = require('helmet');
   ```

3. In `backend/server.js` helmet als ERSTES Middleware aktivieren -- VOR `app.use(generalLimiter)` (vor Zeile 223), direkt nach dem Kommentar "MIDDLEWARE SETUP":
   ```javascript
   // Security Headers
   app.use(helmet({
     contentSecurityPolicy: false,
     strictTransportSecurity: false
   }));
   ```
   WICHTIG: contentSecurityPolicy: false weil reines API-Backend (kein HTML). strictTransportSecurity: false weil Apache/KeyHelp bereits HSTS setzt.

4. Sicherstellen dass die Reihenfolge ist: helmet -> generalLimiter -> express.json()
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/backend && node -e "const helmet = require('helmet'); console.log('helmet OK:', typeof helmet)" && grep -n "helmet" server.js | head -5</automated>
  </verify>
  <done>helmet ist in package.json als Dependency, in server.js importiert und als erstes Middleware vor generalLimiter aktiviert. contentSecurityPolicy und strictTransportSecurity sind deaktiviert.</done>
</task>

<task type="auto">
  <name>Task 2: Zentrale Validierungs-Middleware und getPointField Helper erstellen</name>
  <files>backend/middleware/validation.js</files>
  <action>
Neue Datei `backend/middleware/validation.js` erstellen mit:

1. **handleValidationErrors** Middleware -- wird von express-validator Chains in Plan 03 genutzt:
   ```javascript
   const { validationResult } = require('express-validator');

   const handleValidationErrors = (req, res, next) => {
     const errors = validationResult(req);
     if (!errors.isEmpty()) {
       return res.status(400).json({
         error: 'Validierungsfehler',
         details: errors.array().map(e => ({
           field: e.path,
           message: e.msg
         }))
       });
     }
     next();
   };
   ```

2. **getPointField** Hilfsfunktion -- Whitelist-validierter Spaltennamen-Resolver:
   ```javascript
   const VALID_POINT_FIELDS = {
     gottesdienst: 'gottesdienst_points',
     gemeinde: 'gemeinde_points'
   };

   function getPointField(type) {
     const field = VALID_POINT_FIELDS[type];
     if (!field) {
       throw new Error('Ungueltiger Punktetyp');
     }
     return field;
   }
   ```

3. Beide exportieren: `module.exports = { handleValidationErrors, getPointField };`
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/backend && node -e "const { handleValidationErrors, getPointField } = require('./middleware/validation'); console.log('handleValidationErrors:', typeof handleValidationErrors); console.log('getPointField gottesdienst:', getPointField('gottesdienst')); console.log('getPointField gemeinde:', getPointField('gemeinde')); try { getPointField('invalid'); } catch(e) { console.log('invalid type throws:', e.message); }"</automated>
  </verify>
  <done>middleware/validation.js existiert, exportiert handleValidationErrors und getPointField. getPointField('gottesdienst') gibt 'gottesdienst_points' zurueck, getPointField('gemeinde') gibt 'gemeinde_points', und getPointField('invalid') wirft einen Fehler.</done>
</task>

<task type="auto">
  <name>Task 3: SQL-Injection-Risiko in activities.js und konfi-managment.js beheben</name>
  <files>backend/routes/activities.js, backend/routes/konfi-managment.js</files>
  <action>
In beiden Dateien den `getPointField` Helper importieren und an ALLEN Stellen mit dynamischen Spaltennamen verwenden.

**activities.js (4 Stellen):**

1. Am Anfang der Datei (nach den bestehenden requires) importieren:
   ```javascript
   const { getPointField } = require('../middleware/validation');
   ```

2. Zeile ~210 (reset-to-pending, Punkte abziehen):
   VORHER: `const pointField = request.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const pointField = getPointField(request.type);`

3. Zeile ~274 (approve request, Punkte addieren):
   VORHER: `const pointField = request.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const pointField = getPointField(request.type);`

4. Zeile ~373 (assign-activity, Punkte addieren):
   VORHER: `const pointField = activity.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const pointField = getPointField(activity.type);`

5. Zeile ~405 (assign-bonus, Punkte addieren -- KRITISCH: hier kommt type aus req.body!):
   VORHER: `const pointField = type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const pointField = getPointField(type);`
   Den try/catch in diesem Endpoint um einen getPointField-Fehler erweitern:
   ```javascript
   try {
     const pointField = getPointField(type);
     // ... rest of handler
   } catch (err) {
     if (err.message === 'Ungueltiger Punktetyp') {
       return res.status(400).json({ error: 'Ungueltiger Punktetyp. Erlaubt: gottesdienst, gemeinde' });
     }
     // ... existing error handler
   }
   ```

**konfi-managment.js (4 Stellen):**

1. Am Anfang importieren:
   ```javascript
   const { getPointField } = require('../middleware/validation');
   ```

2. Zeile ~438 (bonus-points POST):
   VORHER: `const updateField = type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const updateField = getPointField(type);`

3. Zeile ~479 (bonus-points DELETE):
   VORHER: `const updateField = bonus.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const updateField = getPointField(bonus.type);`

4. Zeile ~525 (activities POST):
   VORHER: `const updateField = activity.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const updateField = getPointField(activity.type);`

5. Zeile ~571 (activities DELETE):
   VORHER: `const updateField = activity.type === 'gottesdienst' ? 'gottesdienst_points' : 'gemeinde_points';`
   NACHHER: `const updateField = getPointField(activity.type);`

Fuer die POST-Endpoints in konfi-managment.js (bonus-points und activities) ebenfalls den getPointField-Fehler abfangen:
```javascript
try {
  const updateField = getPointField(type); // oder bonus.type / activity.type
  // ... rest
} catch (err) {
  if (err.message === 'Ungueltiger Punktetyp') {
    return res.status(400).json({ error: 'Ungueltiger Punktetyp. Erlaubt: gottesdienst, gemeinde' });
  }
  // ... existing
}
```

WICHTIG: Die SQL-Queries selbst (mit ${pointField} bzw ${updateField}) bleiben unveraendert -- die Whitelist-Validierung stellt sicher dass nur sichere Werte durchkommen.
  </action>
  <verify>
    <automated>cd /Users/simonluthe/Documents/Konfipoints/backend && grep -n "getPointField" routes/activities.js routes/konfi-managment.js | wc -l && echo "---" && grep -n "=== 'gottesdienst' ? 'gottesdienst_points'" routes/activities.js routes/konfi-managment.js | wc -l</automated>
  </verify>
  <done>Alle 8 Stellen mit dynamischen Spaltennamen (4 in activities.js, 4 in konfi-managment.js) verwenden getPointField statt Ternary-Operatoren. grep nach dem alten Ternary-Pattern findet 0 Treffer. grep nach getPointField findet mindestens 8 Treffer (4 pro Datei + imports).</done>
</task>

</tasks>

<verification>
1. `cd backend && node -e "require('helmet')"` -- kein Fehler
2. `grep -c "app.use(helmet" backend/server.js` -- Ergebnis: 1
3. `grep -c "getPointField" backend/routes/activities.js` -- mindestens 5 (1 import + 4 Verwendungen)
4. `grep -c "getPointField" backend/routes/konfi-managment.js` -- mindestens 5 (1 import + 4 Verwendungen)
5. `grep -c "=== 'gottesdienst' ? 'gottesdienst_points'" backend/routes/activities.js backend/routes/konfi-managment.js` -- Ergebnis: 0
6. `node -e "const { getPointField } = require('./backend/middleware/validation'); try { getPointField('hack'); process.exit(1); } catch(e) { console.log('Whitelist works'); }"` -- gibt "Whitelist works" aus
</verification>

<success_criteria>
- helmet ist installiert und als erstes Middleware in server.js aktiv (mit CSP und HSTS deaktiviert)
- express-validator ist installiert (wird in Plan 03 verwendet)
- middleware/validation.js existiert mit handleValidationErrors und getPointField
- Alle 8 Template-Literal-Spaltennamen sind durch getPointField ersetzt
- Ungueltiger type-Wert fuehrt zu 400-Fehler statt stillem Fallback
</success_criteria>

<output>
After completion, create `.planning/phases/01-security-hardening/01-01-SUMMARY.md`
</output>
