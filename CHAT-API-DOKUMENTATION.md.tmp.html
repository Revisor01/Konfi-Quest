<meta charset="UTF-8">
<h1>Chat System API Dokumentation</h1>

<h2>Übersicht</h2>

<p>Das Chat-System unterstützt Multi-Room-Chats mit verschiedenen Nachrichtentypen, Datei-Uploads, Polls und Push-Notifications. Alle Routen erfordern <code>verifyTokenRBAC</code> Authentifizierung.</p>

<hr />

<h2>Datenbank-Architektur</h2>

<h3>Kern-Tabellen:</h3>

<p>```sql
-- Chat Räume
chat<em>rooms: id, name, type, jahrgang</em>id, created<em>by, organization</em>id</p>

<p>-- Nachrichten <br />
chat<em>messages: id, room</em>id, user<em>id, user</em>type, message<em>type, content, file</em>path, file<em>name, file</em>size, reply<em>to, created</em>at, deleted_at</p>

<p>-- Teilnehmer
chat<em>participants: id, room</em>id, user<em>id, user</em>type, joined_at</p>

<p>-- Read Status
chat<em>read</em>status: id, room<em>id, user</em>id, last<em>read</em>at</p>

<p>-- Polls
chat<em>polls: id, message</em>id, question, options (JSON as TEXT), multiple<em>choice, expires</em>at</p>

<p>-- Poll Votes
chat<em>poll</em>votes: id, poll<em>id, user</em>id, user<em>type, option</em>index, voted_at
```</p>

<hr />

<h2>API Endpoints</h2>

<h3>1. GET <code>/api/chat/rooms</code></h3>

<p><strong>Zweck:</strong> Alle Chat-Räume für den aktuellen User abrufen</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code></p>

<p><strong>Response:</strong>
<code>json
[
  {
    "id": 1,
    "name": "2024/25 Jahrgang",
    "type": "jahrgang",
    "jahrgang_id": 5,
    "created_by": 1,
    "organization_id": 1,
    "created_at": "2024-01-01T10:00:00Z",
    "unread_count": 3,
    "last_message": {
      "content": "Hallo zusammen!",
      "sender_name": "Max Mustermann",
      "created_at": "2024-01-01T12:00:00Z"
    }
  }
]
</code></p>

<p><strong>Funktionsweise:</strong>
- Lädt alle Räume basierend auf <code>chat_participants</code> Membership
- Berechnet <code>unread_count</code> basierend auf <code>chat_read_status.last_read_at</code>
- Lädt die letzte Nachricht für Preview
- Filtert nach <code>organization_id</code> für Multi-Tenancy</p>

<hr />

<h3>2. GET <code>/api/chat/rooms/:roomId/messages</code></h3>

<p><strong>Zweck:</strong> Nachrichten für einen Chat-Raum laden</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> + Room-Access-Check</p>

<p><strong>Parameter:</strong>
- <code>:roomId</code> - Chat Room ID
- <code>?limit=50</code> - Anzahl Messages (default: 50)
- <code>?offset=0</code> - Offset für Pagination (default: 0)</p>

<p><strong>Response:</strong>
<code>json
{
  "messages": [
    {
      "id": 123,
      "room_id": 1,
      "sender_id": 45,
      "sender_type": "konfi",
      "sender_name": "Max Mustermann",
      "sender_username": "max.mustermann",
      "message_type": "text",
      "content": "Hallo zusammen!",
      "created_at": "2024-01-01T12:00:00Z",
      "is_deleted": false,
      "reply_to": null
    },
    {
      "id": 124,
      "message_type": "poll",
      "content": "Was wollen wir nächste Woche machen?",
      "question": "Was wollen wir nächste Woche machen?",
      "options": ["Gottesdienst", "Ausflug", "Basteln"],
      "multiple_choice": false,
      "expires_at": "2024-01-08T12:00:00Z",
      "poll_id": 15,
      "votes": [
        {
          "user_id": 45,
          "user_type": "konfi",
          "option_index": 0,
          "voter_name": "Max Mustermann"
        }
      ]
    },
    {
      "id": 125,
      "message_type": "file",
      "content": "",
      "file_path": "/uploads/chat/abc123.jpg",
      "file_name": "gruppenfoto.jpg",
      "file_size": 245760
    }
  ],
  "room": {
    "id": 1,
    "name": "2024/25 Jahrgang",
    "type": "jahrgang"
  }
}
</code></p>

<p><strong>Wichtige Features:</strong>
- <strong>Poll Support:</strong> <code>options</code> werden von JSON-Text zu Array geparst
- <strong>File Attachments:</strong> Dateiname, Größe und Pfad
- <strong>Soft Delete:</strong> Gelöschte Nachrichten zeigen "Diese Nachricht wurde gelöscht"
- <strong>Reply Threading:</strong> <code>reply_to</code> für Antworten auf andere Nachrichten</p>

<hr />

<h3>3. POST <code>/api/chat/rooms/:roomId/messages</code></h3>

<p><strong>Zweck:</strong> Neue Nachricht senden (Text, Datei oder Poll)</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> + Room-Access-Check</p>

<p><strong>Content-Type:</strong> <code>multipart/form-data</code> (für Datei-Uploads)</p>

<p><strong>Request Body (Text Message):</strong>
<code>json
{
  "content": "Hallo zusammen!",
  "message_type": "text",
  "reply_to": 122
}
</code></p>

<p><strong>Request Body (Poll):</strong>
<code>json
{
  "content": "Was wollen wir machen?",
  "message_type": "poll",
  "poll_question": "Was wollen wir nächste Woche machen?",
  "poll_options": ["Gottesdienst", "Ausflug", "Basteln"],
  "poll_multiple_choice": false,
  "poll_expires_at": "2024-01-08T12:00:00Z"
}
</code></p>

<p><strong>Request Body (File Upload):</strong>
<code>
FormData:
- file: [Binary File Data]
- content: "Schaut mal das Foto!"
- message_type: "file"
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "id": 126,
  "room_id": 1,
  "sender_id": 45,
  "sender_name": "Max Mustermann",
  "message_type": "text",
  "content": "Hallo zusammen!",
  "created_at": "2024-01-01T12:05:00Z"
}
</code></p>

<p><strong>File Upload Unterstützung:</strong>
- <strong>Erlaubte Formate:</strong> jpeg, jpg, png, gif, heic, webp, pdf, mp3, wav, m4a, mp4, mov, avi, docx, txt, pptx, xlsx, rtf, zip
- <strong>Max Größe:</strong> 10MB
- <strong>Speicherort:</strong> <code>/uploads/chat/</code>
- <strong>MIME-Type Validation:</strong> Strenge Prüfung gegen erlaubte MIME-Types</p>

<hr />

<h3>4. POST <code>/api/chat/rooms/:roomId/polls/:pollId/vote</code></h3>

<p><strong>Zweck:</strong> Für Poll-Option abstimmen</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> + Room-Access-Check</p>

<p><strong>Request Body:</strong>
<code>json
{
  "option_index": 1
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Vote recorded successfully",
  "poll_id": 15,
  "option_index": 1,
  "user_id": 45
}
</code></p>

<p><strong>Funktionsweise:</strong>
- Prüft, ob Poll noch nicht abgelaufen ist (<code>expires_at</code>)
- Bei Single-Choice: Entfernt vorherige Stimme desselben Users
- Bei Multiple-Choice: Erlaubt mehrere Stimmen
- Verhindert doppelte Stimmen für dieselbe Option</p>

<hr />

<h3>5. POST <code>/api/chat/rooms/:roomId/mark-read</code></h3>

<p><strong>Zweck:</strong> Raum als gelesen markieren</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> + Room-Access-Check</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Room marked as read",
  "room_id": 1,
  "last_read_at": "2024-01-01T12:10:00Z"
}
</code></p>

<p><strong>Funktionsweise:</strong>
- Aktualisiert <code>chat_read_status.last_read_at</code> auf aktuelle Zeit
- Wird für Unread-Counter in Room-Liste verwendet
- UPSERT Operation (INSERT oder UPDATE)</p>

<hr />

<h3>6. DELETE <code>/api/chat/rooms/:roomId/messages/:messageId</code></h3>

<p><strong>Zweck:</strong> Nachricht löschen (Soft Delete)</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> + Message-Owner-Check</p>

<p><strong>Response:</strong>
<code>json
{
  "message": "Message deleted successfully",
  "message_id": 123
}
</code></p>

<p><strong>Funktionsweise:</strong>
- <strong>Soft Delete:</strong> Setzt <code>deleted_at</code> Timestamp
- Nachricht wird als "Diese Nachricht wurde gelöscht" angezeigt
- Nur Eigentümer oder Admins können löschen
- Datei-Attachments bleiben physisch erhalten</p>

<hr />

<h3>7. POST <code>/api/chat/rooms</code></h3>

<p><strong>Zweck:</strong> Neuen Chat-Raum erstellen</p>

<p><strong>Berechtigung:</strong> <code>verifyTokenRBAC</code> (meist nur Admins)</p>

<p><strong>Request Body:</strong>
<code>json
{
  "name": "Spezial Gruppe",
  "type": "custom",
  "jahrgang_id": null
}
</code></p>

<p><strong>Response:</strong>
<code>json
{
  "id": 15,
  "name": "Spezial Gruppe",
  "type": "custom",
  "organization_id": 1,
  "created_by": 1
}
</code></p>

<p><strong>Room Types:</strong>
- <code>jahrgang</code> - Automatischer Jahrgang-Chat
- <code>custom</code> - Manuell erstellter Raum
- <code>direct</code> - 1:1 Direct Messages (geplant)</p>

<hr />

<h2>File Serving</h2>

<h3>GET <code>/api/chat/files/:filename</code></h3>

<p><strong>Zweck:</strong> Chat-Dateien ausliefern</p>

<p><strong>Berechtigung:</strong> Keine (öffentlich über NGINX)</p>

<p><strong>Response:</strong> Binary File Data mit korrekten MIME-Headers</p>

<p><strong>Beispiel:</strong> 
<code>
GET /api/chat/files/abc123_gruppenfoto.jpg
→ Liefert JPEG-Datei mit Content-Type: image/jpeg
</code></p>

<hr />

<h2>Push Notifications</h2>

<h3>Integration mit FCM (Firebase Cloud Messaging)</h3>

<ul>
<li><strong>Trigger:</strong> Neue Nachricht in Room</li>
<li><strong>Payload:</strong> 
<code>json
{
"title": "Neue Nachricht in 2024/25 Jahrgang",
"body": "Max Mustermann: Hallo zusammen!",
"data": {
  "room_id": "1",
  "message_id": "123",
  "sender_id": "45"
}
}
</code></li>
<li><strong>Filtering:</strong> Nur an Room-Teilnehmer (außer Sender)</li>
</ul>

<hr />

<h2>Sicherheitsaspekte</h2>

<h3>1. <strong>Room Access Control</strong></h3>

<p><code>sql
-- Prüfung für jeden Message-Request:
SELECT 1 FROM chat_participants cp 
JOIN chat_rooms cr ON cp.room_id = cr.id 
WHERE cp.room_id = $1 AND cp.user_id = $2 AND cr.organization_id = $3
</code></p>

<h3>2. <strong>Organization Isolation</strong></h3>

<ul>
<li>Alle Räume haben <code>organization_id</code></li>
<li>Cross-Organization Access wird blockiert</li>
<li>Teilnehmer können nur Räume ihrer Organisation sehen</li>
</ul>

<h3>3. <strong>File Upload Security</strong></h3>

<ul>
<li><strong>Extension Whitelist:</strong> Nur erlaubte Dateitypen</li>
<li><strong>MIME-Type Validation:</strong> Doppelte Prüfung gegen Spoofing</li>
<li><strong>Size Limits:</strong> 10MB Maximum</li>
<li><strong>Isolation:</strong> Files in <code>/uploads/chat/</code> mit Random-Namen</li>
</ul>

<h3>4. <strong>Poll Security</strong></h3>

<ul>
<li><strong>Expiration Check:</strong> Votes nur vor <code>expires_at</code></li>
<li><strong>Duplicate Prevention:</strong> UNIQUE constraint auf (poll<em>id, user</em>id, option_index)</li>
<li><strong>JSON Validation:</strong> Options werden serverseitig validiert</li>
</ul>

<hr />

<h2>Performance Considerations</h2>

<h3>1. <strong>Message Pagination</strong></h3>

<ul>
<li>Default: 50 Messages pro Request</li>
<li>LIMIT/OFFSET für ältere Nachrichten</li>
<li>Index auf <code>(room_id, created_at DESC)</code></li>
</ul>

<h3>2. <strong>Unread Count Optimization</strong></h3>

<p><code>sql
-- Efficient unread counting:
SELECT COUNT(*) FROM chat_messages cm 
LEFT JOIN chat_read_status crs ON cm.room_id = crs.room_id AND crs.user_id = $1
WHERE cm.room_id = $2 AND (crs.last_read_at IS NULL OR cm.created_at &gt; crs.last_read_at)
</code></p>

<h3>3. <strong>Poll Vote Aggregation</strong></h3>

<ul>
<li>Votes werden bei Message-Load aggregiert</li>
<li>Könnte bei vielen Votes zu Materialized Views optimiert werden</li>
</ul>

<hr />

<h2>Häufige Fehlerquellen</h2>

<h3>1. <strong>Poll Options Parsing</strong></h3>

<p><strong>Problem:</strong> <code>options</code> als TEXT gespeichert, Frontend erwartet Array
<strong>Lösung:</strong> JSON.parse() im Backend vor Response</p>

<h3>2. <strong>File Upload CORS</strong></h3>

<p><strong>Problem:</strong> Multipart uploads scheitern bei CORS-Problemen <br />
<strong>Lösung:</strong> Korrekte CORS-Headers für file endpoints</p>

<h3>3. <strong>Room Access Denial</strong></h3>

<p><strong>Problem:</strong> 403 Errors bei legitimen Usern
<strong>Debug:</strong> <code>chat_participants</code> Membership prüfen</p>

<h3>4. <strong>Push Notification Failures</strong></h3>

<p><strong>Problem:</strong> FCM Tokens expired oder ungültig
<strong>Lösung:</strong> Token-Refresh-Mechanismus implementiert</p>

<hr />

<h2>Database Schema Updates für Performance</h2>

<h3>Empfohlene Indexes:</h3>

<p>```sql
-- Message Loading Performance
CREATE INDEX idx<em>chat</em>messages<em>room</em>created ON chat<em>messages (room</em>id, created_at DESC);</p>

<p>-- Unread Count Performance <br />
CREATE INDEX idx<em>chat</em>read<em>status</em>user<em>room ON chat</em>read<em>status (user</em>id, room_id);</p>

<p>-- Poll Performance
CREATE INDEX idx<em>chat</em>poll<em>votes</em>poll ON chat<em>poll</em>votes (poll<em>id);
CREATE INDEX idx</em>chat<em>polls</em>message ON chat<em>polls (message</em>id);</p>

<p>-- File Access
CREATE INDEX idx<em>chat</em>messages<em>file</em>path ON chat<em>messages (file</em>path) WHERE file_path IS NOT NULL;
```</p>
